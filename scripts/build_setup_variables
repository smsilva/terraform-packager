#!/bin/bash
TF_PACKAGER_RUN_SCRIPT="${1}"

TF_PACKAGER_ENVIRONMENT_VARIABLES_BASE_FILE_NAME="environment_variables.conf"
TF_PACKAGER_TEMPORARY_DIRECTORY="${HOME}/.terraform-packager"
TF_PACKAGER_TEMPORARY_BUILD_CONTEXT_DIRECTORY="${TF_PACKAGER_TEMPORARY_DIRECTORY}/build/context"
TF_PACKAGER_TEMPLATES_DIRECTORY="${TF_PACKAGER_ROOT_DIRECTORY}/templates"
TF_PACKAGER_SCRIPTS_DIRECTORY_BUILD="${TF_PACKAGER_TEMPLATES_DIRECTORY}/scripts"
TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME_TEMPLATE="${TF_PACKAGER_TEMPLATES_DIRECTORY}/${TF_PACKAGER_ENVIRONMENT_VARIABLES_BASE_FILE_NAME}"
TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME="${TF_PACKAGER_TEMPORARY_BUILD_CONTEXT_DIRECTORY}/${TF_PACKAGER_ENVIRONMENT_VARIABLES_BASE_FILE_NAME}"
TF_PACKAGER_STACK_CONFIG_YAML_FILE="${TF_PROJECT_DIRECTORY}/stack.yaml"
TF_PACKAGER_SOURCE_CODE_PROVIDER_FILE="${TF_SOURCE_CODE_DIRECTORY}/provider.tf"
TF_PACKAGER_SOURCE_CODE_TFVARS_FILE="${TF_SOURCE_CODE_DIRECTORY}/terraform.tfvars"
TF_PACKAGER_SOURCE_CODE_COMMITIZEN_FILE="${TF_SOURCE_CODE_DIRECTORY}/cz.yaml"

export TF_PACKAGER_TEMPORARY_DIRECTORY
export TF_PACKAGER_RUN_SCRIPT
export TF_PACKAGER_ROOT_DIRECTORY
export TF_PACKAGER_SCRIPTS_DIRECTORY_BUILD
export TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME_TEMPLATE
export TF_PACKAGER_ENVIRONMENT_VARIABLES_FILE_NAME
export TF_PACKAGER_TEMPLATES_DIRECTORY
export TF_SOURCE_CODE_DIRECTORY
export TF_PACKAGER_SOURCE_CODE_PROVIDER_FILE
export TF_PACKAGER_SOURCE_CODE_TFVARS_FILE
export TF_PACKAGER_SOURCE_CODE_STACK_CONFIG_FILE
export TF_PACKAGER_TEMPORARY_BUILD_CONTEXT_DIRECTORY

mkdir -p "${TF_PACKAGER_TEMPORARY_DIRECTORY}"

if [ ! -e "${TF_PACKAGER_STACK_CONFIG_YAML_FILE}" ]; then
  echo "The stack.yaml file doesn't exists."
  echo ""
  echo "A file like the example below is expected:"

  echo ""
  echo "  ${TF_PACKAGER_STACK_CONFIG_YAML_FILE}"
  echo ""
  cat templates/stack.yaml
  echo ""

  exit 1
fi

STACK_NAME=$(yq e .name "${TF_PACKAGER_STACK_CONFIG_YAML_FILE}")
STACK_VERSION=$(yq e .version "${TF_PACKAGER_STACK_CONFIG_YAML_FILE}")

if [[ -z "${STACK_VERSION}" || "${STACK_VERSION}" == "null" ]]; then
  if [ -e "${TF_PACKAGER_SOURCE_CODE_COMMITIZEN_FILE}" ]; then
    STACK_VERSION=$(yq e .commitizen.version "${TF_PACKAGER_SOURCE_CODE_COMMITIZEN_FILE}")
  else
    if [ -e "${TF_PROJECT_DIRECTORY?}/.git" ]; then
      STACK_VERSION="$(git -C "${TF_PROJECT_DIRECTORY?}" log -1 --pretty=%h)"
    fi
  fi
fi

if [[ -z "${STACK_VERSION}" || "${STACK_VERSION}" == "null" ]]; then
  STACK_VERSION="undefined"
fi

TERRAFORM_VERSION=$(yq e .terraform.version "${TF_PACKAGER_STACK_CONFIG_YAML_FILE}")
TERRAFORM_BACKEND=$(yq e .terraform.backend "${TF_PACKAGER_STACK_CONFIG_YAML_FILE}")
TERRAFORM_PROVIDER=$(grep "^provider" "${TF_PACKAGER_SOURCE_CODE_PROVIDER_FILE?}" | grep -oP '(?<=\")(.*)(?=\")')

TERRAFORM_PROVIDER_TEMPLATE_CREDENTIALS_FILE="${TF_PACKAGER_TEMPLATES_DIRECTORY}/provider/${TERRAFORM_PROVIDER}/credentials_build.conf"
TERRAFORM_BACKEND_TEMPLATE_CREDENTIALS_FILE="${TF_PACKAGER_TEMPLATES_DIRECTORY}/backend/${TERRAFORM_BACKEND}/credentials_build.conf"
TERRAFORM_BACKEND_TEMPLATE_FILE="${TF_PACKAGER_TEMPLATES_DIRECTORY}/backend/${TERRAFORM_BACKEND}/backend.conf"
TERRAFORM_BACKEND_TEMPLATE_FRAGMENT="${TF_PACKAGER_TEMPLATES_DIRECTORY}/backend/${TERRAFORM_BACKEND}/backend.hcl"

export STACK_NAME
export STACK_VERSION
export STACK_INSTANCE_NAME=${STACK_INSTANCE_NAME-default}

export TERRAFORM_VERSION
export TERRAFORM_PROVIDER
export TERRAFORM_PROVIDER_TEMPLATE_CREDENTIALS_FILE

export TERRAFORM_BACKEND
export TERRAFORM_BACKEND_TEMPLATE_FILE
export TERRAFORM_BACKEND_TEMPLATE_FRAGMENT
export TERRAFORM_BACKEND_TEMPLATE_CREDENTIALS_FILE
